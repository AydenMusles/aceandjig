<div data-section-type="collection-template">
{% paginate collection.products by section.settings.coll_num_per_page_int %}

<div class="container">
  <div class="page-header cf">
    {% if section.settings.coll_desc_pos == 'below' %}
    <h1 class="majortitle">{{ collection.title | escape }}</h1>
    {% endif %}

    {% if collection.description != blank %}
    <div class="user-content lightly-spaced-row {% if settings.lightbox_imgs %}lightboximages{% endif %}">
      {{ collection.description }}
    </div>
    {% endif %}

    {% if section.settings.coll_desc_pos == 'above' %}
    <h1 class="majortitle">{{ collection.title | escape }}</h1>
    {% endif %}

    {% comment %} Which tags should we show, and group them into categories {% endcomment %}
    {% assign show_normal_filter = false %}
    {% assign show_custom_filter_1 = false %}
    {% assign show_custom_filter_2 = false %}
    {% assign show_custom_filter_3 = false %}

    {% if section.settings.show_tagfilt_custom1 %}
    {% assign custom_tag_arr1 = section.settings.tagfilt_custom1_tags | replace: ', ',',' | split: ',' %}
    {% capture filter1_html %}
    {% for tag in custom_tag_arr1 %}
      {% unless tag contains 'meta-' %}
      {% if custom_tag_arr1 contains tag %}
        {% assign show_custom_filter_1 = true %}
        {% if current_tags contains tag %}
        <li class="active" data-tag="{{tag | handleize}}">{{ tag | append: ' <span class="x">&times;</span>' | link_to_remove_tag: tag }}</li>
        {% else %}
        <li data-tag="{{tag | handleize}}">{{ tag | link_to_add_tag: tag }}</li>
        {% endif %}
      {% endif %}
      {% endunless %}
    {% endfor %}
    {% endcapture %}
    {% endif %}

    {% if section.settings.show_tagfilt_custom2 %}
    {% assign custom_tag_arr2 = section.settings.tagfilt_custom2_tags | replace: ', ',',' | split: ',' %}
    {% capture filter2_html %}
    {% for tag in collection.all_tags %}
      {% unless tag contains 'meta-' %}
      {% if custom_tag_arr2 contains tag %}
        {% assign show_custom_filter_2 = true %}
        {% if current_tags contains tag %}
        <li class="active" data-tag="{{tag | handleize}}">{{ tag | append: ' <span class="x">&times;</span>' | link_to_remove_tag: tag }}</li>
        {% else %}
        <li data-tag="{{tag | handleize}}">{{ tag | link_to_add_tag: tag }}</li>
        {% endif %}
      {% endif %}
      {% endunless %}
    {% endfor %}
    {% endcapture %}
    {% endif %}

    {% if section.settings.show_tagfilt_custom3 %}
        {% assign custom_tag_arr3 = section.settings.tagfilt_custom3_tags | replace: ', ',',' | split: ',' %}
        {% capture filter3_html %}
        {% for tag in custom_tag_arr3 %}
            {% if tag == 'one size' %}
              <li{% if current_tags contains tag %} class="active"{% endif %}><a href="/collections/{{ tag | handle }}">{{ tag }}</a></li>
            {% endif %}
        {% endfor %}
     
    {% for tag in custom_tag_arr3 %}
            {% if tag == 'XXS' %}
                <li{% if current_tags contains tag %} class="active"{% endif %}><a href="/collections/{{ tag | handle }}">{{ tag }}</a></li>
                {% comment %}
              {% unless tag contains 'meta-' %}
              {% if custom_tag_arr3 contains tag %}
                {% assign show_custom_filter_3 = true %}
                {% if current_tags contains tag %}
                <li class="active" data-tag="{{tag | handleize}}">{{ tag | append: ' <span class="x">&times;</span>' | link_to_remove_tag: tag }}</li>
                {% else %}
                <li data-tag="{{tag | handleize}}">{{ tag | link_to_add_tag: tag }}</li>
                {% endif %}
              {% endif %}
              {% endunless %}
              {% endcomment %}
            {% endif %}
        {% endfor %}
  
    
        {% for tag in custom_tag_arr3 %}
            {% if tag == 'XS' %}
                <li{% if current_tags contains tag %} class="active"{% endif %}><a href="/collections/extra-small">{{ tag }}</a></li>
                {% comment %}
              {% unless tag contains 'meta-' %}
              {% if custom_tag_arr3 contains tag %}
                {% assign show_custom_filter_3 = true %}
                {% if current_tags contains tag %}
                <li class="active" data-tag="{{tag | handleize}}">{{ tag | append: ' <span class="x">&times;</span>' | link_to_remove_tag: tag }}</li>
                {% else %}
                <li data-tag="{{tag | handleize}}">{{ tag | link_to_add_tag: tag }}</li>
                {% endif %}
              {% endif %}
              {% endunless %}
              {% endcomment %}
            {% endif %}
        {% endfor %}
        {% for tag in collection.all_tags %}
            {% if tag == 'S' %}
              <li{% if current_tags contains tag %} class="active"{% endif %}><a href="/collections/small">{{ tag }}</a></li>
            {% endif %}
        {% endfor %}
        {% for tag in collection.all_tags %}
            {% if tag == 'M' %}
              <li{% if current_tags contains tag %} class="active"{% endif %}><a href="/collections/medium">{{ tag }}</a></li>
            {% endif %}
        {% endfor %}
        {% for tag in collection.all_tags %}
            {% if tag == 'L' %}
              <li{% if current_tags contains tag %} class="active"{% endif %}><a href="/collections/large">{{ tag }}</a></li>
            {% endif %}
        {% endfor %}
   
        {% for tag in collection.all_tags %}
            {% if tag == 'XL' %}
              {% unless tag contains 'meta-' %}
              {% if custom_tag_arr3 contains tag %}
                {% assign show_custom_filter_3 = true %}
                {% if current_tags contains tag %}
                <li class="active"><a href="/collections/extra-large">{{ tag }}</a></li>
                {% else %}
                <li><a href="/collections/extra-large">{{ tag }}</a></li>
                {% endif %}
              {% endif %}
              {% endunless %}
            {% endif %}
        {% endfor %}
    
    
        {% for tag in custom_tag_arr3 %}
            {% if tag == '1X' %}
                <li{% if current_tags contains tag %} class="active"{% endif %}><a href="/collections/{{ tag | handle }}">{{ tag }}</a></li>
                {% comment %}
              {% unless tag contains 'meta-' %}
              {% if custom_tag_arr3 contains tag %}
                {% assign show_custom_filter_3 = true %}
                {% if current_tags contains tag %}
                <li class="active" data-tag="{{tag | handleize}}">{{ tag | append: ' <span class="x">&times;</span>' | link_to_remove_tag: tag }}</li>
                {% else %}
                <li data-tag="{{tag | handleize}}">{{ tag | link_to_add_tag: tag }}</li>
                {% endif %}
              {% endif %}
              {% endunless %}
              {% endcomment %}
            {% endif %}
        {% endfor %}
    
        {% for tag in custom_tag_arr3 %}
            {% if tag == '2X' %}
                <li{% if current_tags contains tag %} class="active"{% endif %}><a href="/collections/{{ tag | handle }}">{{ tag }}</a></li>
                {% comment %}
              {% unless tag contains 'meta-' %}
              {% if custom_tag_arr3 contains tag %}
                {% assign show_custom_filter_3 = true %}
                {% if current_tags contains tag %}
                <li class="active" data-tag="{{tag | handleize}}">{{ tag | append: ' <span class="x">&times;</span>' | link_to_remove_tag: tag }}</li>
                {% else %}
                <li data-tag="{{tag | handleize}}">{{ tag | link_to_add_tag: tag }}</li>
                {% endif %}
              {% endif %}
              {% endunless %}
              {% endcomment %}
            {% endif %}
        {% endfor %}    
    {% endcapture %}
    {% endif %}

    {% if section.settings.coll_show_tags %}
    {% capture filter_html %}
    {% for tag in collection.all_tags %}
      {% unless tag contains 'meta-' or custom_tag_arr1 contains tag or custom_tag_arr2 contains tag or custom_tag_arr3 contains tag %}
        {% assign show_normal_filter = true %}
        {% if current_tags contains tag %}
        <li class="active" data-tag="{{tag | handleize}}">{{ tag | append: ' <span class="x">&times;</span>' | link_to_remove_tag: tag }}</li>
        {% else %}
        <li data-tag="{{tag | handleize}}">{{ tag | link_to_add_tag: tag }}</li>
        {% endif %}
      {% endunless %}
    {% endfor %}
    {% endcapture %}
    {% endif %}


    <div class="filters">
{% comment %}
      {% if show_normal_filter %}
      <a href="#" class="tags" data-toggle-target=".tags.nav-row.cat-normal">{{ 'collections.filtering.filter' | t }} <span class="state">+</span></a>
      {% endif %}
{% endcomment %}
      {% if show_custom_filter_1 %}
      <a href="#" class="tags" data-toggle-target=".tags.nav-row.cat-custom-1">{{ section.settings.tagfilt_custom1_name | escape }} <span class="state">+</span></a>
      {% endif %}

      {% if show_custom_filter_2 %}
      <a href="#" class="tags" data-toggle-target=".tags.nav-row.cat-custom-2">{{ section.settings.tagfilt_custom2_name | escape }} <span class="state">+</span></a>
      {% endif %}

      {% if show_custom_filter_3 %}
      <a href="#" class="tags" data-toggle-target=".tags.nav-row.cat-custom-3">{{ section.settings.tagfilt_custom3_name | escape }} <span class="state">+</span></a>
      {% endif %}


      {% if section.settings.coll_show_sort %}
      <span class="sort tags">
        <label for="sort-by">{{ 'collections.sorting.title' | t }}</label>
        <select id="sort-by" data-initval="{{ collection.sort_by | default: collection.default_sort_by  }}">
          {% if section.settings.coll_show_feat %}<option value="manual">{{ 'collections.sorting.featured' | t }}</option>{% endif %}
          <option value="price-ascending">{{ 'collections.sorting.price_ascending' | t }}</option>
          <option value="price-descending">{{ 'collections.sorting.price_descending' | t }}</option>
          <option value="title-ascending">{{ 'collections.sorting.az' | t }}</option>
          <option value="title-descending">{{ 'collections.sorting.za' | t }}</option>
          <option value="created-ascending">{{ 'collections.sorting.date_ascending' | t }}</option>
          <option value="created-descending">{{ 'collections.sorting.date_descending' | t }}</option>
          <option value="best-selling">{{ 'collections.sorting.best_selling' | t }}</option>
        </select>
      </span>
      {% endif %}

      {% if section.settings.coll_gridstream_toggle %}
      <span class="view-as">
        <span class="view-as-label">{{ 'collections.general.view' | t }}</span>
        <a id="view-as-tiles" {% if section.settings.coll_gridstream_mode == 'grid' %}class="active"{% endif %} href="#">{{ 'collections.general.grid' | t }} <div class="fluff1"></div><div class="fluff2"></div><div class="fluff3"></div><div class="fluff4"></div></a>
        <a id="view-as-stream" {% if section.settings.coll_gridstream_mode == 'stream' %}class="active"{% endif %} href="#">{{ 'collections.general.list' | t }} <div class="fluff"></div></a>
      </span>
      {% endif %}
    </div><!-- /.filters -->

	{% comment %}
    <div class="social-area">
      {% include 'social-sharing' %}
    </div>
	{% endcomment %}
  </div><!-- /.page-header -->
</div><!-- /.container -->

<div class="multi-tag-row">
  {% if show_normal_filter %}
  <div class="tags nav-row cat-normal {% unless filter_html contains 'class="active"' %}hidden{% endunless %}">
    <ul>
      {{ filter_html }}
    </ul>
  </div>
  {% endif %}

  {% if show_custom_filter_1 %}
  <div class="tags nav-row cat-custom-1 {% unless filter1_html contains 'class="active"' %}hidden{% endunless %}">
    <ul>
      {{ filter1_html }}
    </ul>
  </div>
  {% endif %}

  {% if show_custom_filter_2 %}
  <div class="tags nav-row cat-custom-2 {% unless filter2_html contains 'class="active"' %}hidden{% endunless %}">
    <ul>
      {{ filter2_html }}
    </ul>
  </div>
  {% endif %}

  {% if show_custom_filter_3 %}
  <div class="tags nav-row cat-custom-3 {% unless filter3_html contains 'class="active"' %}hidden{% endunless %}">
    <ul>
      {{ filter3_html }}
    </ul>
  </div>
  {% endif %}
</div><!-- /.multi-tag-row -->

{% if collection.products.size == 0 %}
    <div class="container"><h5 class="align-centre fully-spaced-row">{{ 'collections.general.no_matches' | t }}</h5></div>
{% else %}
    {% unless settings.use_fullwidth_layout %}<div class="container">{% endunless %}

    {%- if section.settings.coll_gridstream_toggle or section.settings.coll_gridstream_mode == 'stream' -%}
      {%- assign include_quick_buy_markup = true -%}
    {%- else -%}
      {%- assign include_quick_buy_markup = false -%}
    {%- endif -%}

    <div class="collection-listing{% if section.settings.coll_gridstream_mode == 'stream' %}-stream{% endif %} cf">
      <div class="product-list">
        {% for product in collection.products %}
        	{% unless product.type == 'Stockists' %}
        		{% if product.available %}
                	{% include 'product-block' with product, include_quick_buy_markup: include_quick_buy_markup %}
       			{% endif %}
        	{% endunless %}
        {% endfor %}
      </div>
    </div>

    {% unless settings.use_fullwidth_layout %}</div>{% endunless %}
{% endif %}

{% unless collection.products_count <= 12 %}
<div class="loading" style="text-align: center; margin-top: 5rem;"><img style="height: 15px; width: auto;" src="{{ 'loading.gif' | asset_url }}"></div>
{% endunless %}

<div class="container pagination-row">{% include 'pagination-control' %}</div>

<div id="product-list-foot"></div>

{% endpaginate %}
</div>

{% if template contains 'collection' %}
{% unless collection.products_count <= 12 %}
{{ 'tricky3.infinitescroll.v2.min.js' | asset_url | script_tag }}
<script>
  //Ref: templates/collections.v2.liquid
  $(function(){
      var itemsWrapper = '.product-list';
      //Manual loading example
      var manualLoadingOptions = {
          selectors: {
                  itemsWrapper: itemsWrapper,
                  item: '.product-block',
                  nextPageLink: '.next',
                  previousPageLink: '.prev',
                  paginationWrapper: '.pagination'
                },
                pageQueryStringKey: 'page',
                waitForImagesToBeLoaded: false,
                enablePageState: true,
                manualLoading: true,
                callBacks: {
                  onAllPagesLoaded: function(){
                    $('.pagination').css("display", "none");
                  },
                  onPageLoad: function(items){
                  },
                  beforePageLoad: function(){
                  }
                }
      };
      $(itemsWrapper).t3PageLoad(manualLoadingOptions);
      //End manual loading example

      //Scrolling loading example
      var scrollingLoadingOptions = {
          selectors: {
                  itemsWrapper: itemsWrapper,
                  item: '.product-block',
                  nextPageLink: '.next',
                  previousPageLink: '.prev',
                  paginationWrapper: '.pagination',
                  manualLoading: true,
                  //scrollableElem: itemsWrapper, YOU CAN SPECIFY THIS
                },
                waitForImagesToBeLoaded: true,
                //throttleDelay: 100, YOU CAN SPECIFY THIS
                callBacks: {
                  onAllPagesLoaded: function(){
                    $('.pagination').css("display", "none");
                    $('.loading').hide();
                    // console.log('All pages loaded callback called...');
                  },
                  onPageLoad: function(items){
                      $('.loading').hide();
                      $('.product-block').each(function(){
                          var self = $(this);
                          self.find('select.option--color, select.option--textile, select.option--textiles').each(function(){
                              var selectedColor = $(this).val();
                              self.find('.color-options .color-label').html(selectedColor.replace(/-/g, ' '));
                              self.find('.thumbnails a').each(function(){
                                  if ($(this).data('value') == selectedColor) {
                                      $(this).show();
                                  } else {
                                      $(this).hide();
                                  }
                              });
                              $(this).change(function(){
                                  var newVal = $(this).val();
                                  self.find('.color-options .color-label').html(newVal.replace(/-/g, ' '));
                                  self.find('.thumbnails a').each(function(){
                                      if ($(this).data('value') == newVal) {
                                          $(this).show();
                                      } else {
                                          $(this).hide();
                                      }
                                  });
                              });
                          });
                      });
                    // console.log("Page loaded callback called..");
                  },
                  beforePageLoad: function(){
                      $('.loading').show();
                    // console.log("Before page load callback called..");
                  }
                }
      };
      $(itemsWrapper).t3PageLoad(scrollingLoadingOptions);
      //End scrolling loading example
  });
  </script>
 {% endunless %}
{% endif %}


{% schema %}
  {
    "name": "Collection pages",
    "settings": [
      {
        "type": "select",
        "id": "coll_desc_pos",
        "label": "Description position",
        "options": [
          {
            "value": "below",
            "label": "Below collection title"
          },
          {
            "value": "above",
            "label": "Above collection title"
          }
        ]
      },
      {
        "type": "checkbox",
        "id": "coll_show_sort",
        "label": "Show 'sort by' dropdown",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "coll_show_feat",
        "label": "Show 'Featured' in sort by",
        "default": false
      },
      {
        "type": "checkbox",
        "id": "coll_show_tags",
        "label": "Show ungrouped tags",
        "default": true
      },
	  {
        "type": "header",
        "content": "Tag group 1"
      },
      {
        "type": "checkbox",
        "id": "show_tagfilt_custom1",
        "label": "Show",
        "default": false
      },
      {
        "type": "text",
        "id": "tagfilt_custom1_name",
        "label": "Name"
      },
      {
        "type": "text",
        "id": "tagfilt_custom1_tags",
        "label": "Tags to include",
        "info": "Separate with commas"
      },
      {
        "type": "header",
        "content": "Tag group 2"
      },
      {
        "type": "checkbox",
        "id": "show_tagfilt_custom2",
        "label": "Show",
        "default": false
      },
      {
        "type": "text",
        "id": "tagfilt_custom2_name",
        "label": "Name"
      },
      {
        "type": "text",
        "id": "tagfilt_custom2_tags",
        "label": "Tags to include",
        "info": "Separate with commas"
      },
	  {
        "type": "header",
        "content": "Tag group 3"
      },
      {
        "type": "checkbox",
        "id": "show_tagfilt_custom3",
        "label": "Show",
        "default": false
      },
      {
        "type": "text",
        "id": "tagfilt_custom3_name",
        "label": "Name"
      },
      {
        "type": "text",
        "id": "tagfilt_custom3_tags",
        "label": "Tags to include",
        "info": "Separate with commas"
      },
      {
        "type": "header",
        "content": "Layout"
      },
	  {
        "type": "range",
        "id": "coll_num_per_page_int",
        "min": 12,
        "max": 40,
        "step": 4,
        "label": "Number of products to show per page",
        "default": 12
      },
      {
        "type": "select",
        "id": "coll_gridstream_mode",
        "label": "Show products in a grid or a list",
        "options": [
          {
            "value": "grid",
            "label": "Grid"
          },
          {
            "value": "stream",
            "label": "List"
          }
        ],
        "default": "grid"
      },
      {
        "type": "checkbox",
        "id": "coll_gridstream_toggle",
        "label": "Show toggle for grid and list views",
        "default": true
      }
	]
  }
{% endschema %}
